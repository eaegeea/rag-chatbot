<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAG Sales Chatbot - ACME</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .main-container {
            display: flex;
            gap: 20px;
            width: 100%;
            max-width: 1400px;
            height: 90vh;
        }

        .sidebar {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            width: 400px;
            padding: 20px;
            overflow-y: auto;
        }

        .sidebar h2 {
            color: #2d3748;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
            font-size: 20px;
        }

        .region {
            margin-bottom: 30px;
            background: #f7fafc;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #e2e8f0;
        }

        .region-header {
            background: #2d3748;
            color: white;
            padding: 15px 20px;
            font-weight: bold;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .region-header.east {
            background: #48bb78;
        }

        .region-header.west {
            background: #ed8936;
        }

        .manager {
            background: #edf2f7;
            padding: 12px 20px;
            border-bottom: 1px solid #e2e8f0;
            font-weight: 600;
            color: #4a5568;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .manager-badge {
            background: #9f7aea;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: bold;
        }

        .clients {
            padding: 0;
        }

        .client {
            padding: 12px 20px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
        }

        .client:hover {
            background: #f1f5f9;
        }

        .client:last-child {
            border-bottom: none;
        }

        .client-info {
            flex: 1;
        }

        .client-name {
            font-weight: 600;
            color: #2d3748;
            font-size: 14px;
        }

        .client-company {
            color: #718096;
            font-size: 12px;
            margin-top: 2px;
        }

        .salesperson {
            background: #4299e1;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            white-space: nowrap;
        }

        .container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: #2d3748;
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            margin-bottom: 10px;
            font-size: 28px;
        }

        .header p {
            opacity: 0.8;
            font-size: 16px;
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            height: 100%;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: scroll;
            background: #f8f9fa;
            scrollbar-width: thin;
            scrollbar-color: #a0aec0 #f7fafc;
        }

        .chat-messages::-webkit-scrollbar {
            width: 12px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: #f7fafc;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: #a0aec0;
            border-radius: 6px;
            border: 2px solid #f7fafc;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: #718096;
        }

        .chat-messages::-webkit-scrollbar-corner {
            background: #f7fafc;
        }

        .message {
            margin-bottom: 15px;
            padding: 12px 16px;
            border-radius: 12px;
            max-width: 80%;
        }

        .message.user {
            background: #4299e1;
            color: white;
            margin-left: auto;
        }

        .message.assistant {
            background: white;
            border: 1px solid #e2e8f0;
            color: #2d3748;
        }

        .input-container {
            padding: 20px;
            border-top: 1px solid #e2e8f0;
            background: white;
            flex-shrink: 0;
            position: relative;
        }

        .input-group {
            display: flex;
            gap: 10px;
        }

        #messageInput {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
        }

        #messageInput:focus {
            border-color: #4299e1;
        }

        #sendButton {
            background: #4299e1;
            color: white;
            border: none;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        #sendButton:hover {
            background: #3182ce;
        }

        #sendButton:disabled {
            background: #a0aec0;
            cursor: not-allowed;
        }

        .loading {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #718096;
            font-style: italic;
        }

        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid #e2e8f0;
            border-top: 2px solid #4299e1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .suggestions {
            margin-top: 15px;
        }

        .suggestions h4 {
            color: #2d3748;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .suggestion-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .suggestion-btn {
            background: #edf2f7;
            border: 1px solid #e2e8f0;
            border-radius: 16px;
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .suggestion-btn:hover {
            background: #e2e8f0;
        }

        .hidden {
            display: none;
        }

        .loading-text {
            color: #718096;
            text-align: center;
            padding: 20px;
            font-style: italic;
        }

        @media (max-width: 1024px) {
            .main-container {
                flex-direction: column;
                height: auto;
            }
            
            .sidebar {
                width: 100%;
                max-height: 300px;
                order: 2;
            }
            
            .container {
                order: 1;
                min-height: 600px;
            }
        }

        @media (max-width: 640px) {
            .user-details {
                flex-direction: column;
                gap: 8px;
            }
            
            .message {
                max-width: 95%;
            }
            
            .main-container {
                padding: 10px;
            }
        }

        .user-selection {
            padding: 20px;
            border-bottom: 1px solid #e2e8f0;
            background: #f7fafc;
        }

        .user-selection h3 {
            margin-bottom: 15px;
            color: #2d3748;
        }

        .user-dropdown {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            background: white;
            cursor: pointer;
            outline: none;
        }

        .user-dropdown:focus {
            border-color: #4299e1;
        }

        .user-dropdown option {
            padding: 10px;
        }

        .user-info {
            margin-top: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            display: none;
        }

        .user-info.active {
            display: block;
        }

        .user-name {
            font-weight: bold;
            color: #2d3748;
            font-size: 18px;
        }

        .user-details {
            display: flex;
            gap: 20px;
            margin-top: 8px;
            color: #718096;
        }

        .user-role {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .user-region {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .role-badge {
            background: #4299e1;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }

        .role-badge.manager {
            background: #9f7aea;
        }

        .region-badge {
            background: #48bb78;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }

        .region-badge.west {
            background: #ed8936;
        }

        .user-clients {
            margin-top: 10px;
            padding: 5px;
            border-top: 1px solid #e2e8f0;
            background: #f7fafc;
            border-radius: 4px;
            max-height: 20px;
            overflow: hidden;
        }

        .clients-header {
            display: none; /* Hide header to save space */
        }

        .clients-list {
            display: flex;
            gap: 6px;
            overflow-x: auto;
            overflow-y: hidden;
            height: 18px;
            align-items: center;
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE/Edge */
        }

        .clients-list::-webkit-scrollbar {
            display: none; /* Chrome/Safari */
        }

        .loading-clients {
            color: #718096;
            font-style: italic;
            font-size: 10px;
            white-space: nowrap;
            padding: 0 5px;
        }

        .client-item {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 2px 6px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            font-size: 10px;
            white-space: nowrap;
            flex-shrink: 0;
            height: 16px;
            line-height: 1;
        }

        .client-item:hover {
            border-color: #4299e1;
            background: #f0f8ff;
        }

        .client-item-name {
            font-weight: 600;
            color: #2d3748;
        }

        .client-item-company {
            color: #718096;
            font-size: 9px;
        }

        .client-item-region {
            display: none; /* Hide region to save space */
        }

        .no-clients {
            color: #718096;
            font-style: italic;
            font-size: 10px;
            white-space: nowrap;
            padding: 0 5px;
        }

        /* Add a subtle client count indicator */
        .user-clients::after {
            content: attr(data-count) " clients";
            position: absolute;
            right: 10px;
            top: 2px;
            font-size: 8px;
            color: #a0aec0;
            pointer-events: none;
        }

        .user-clients {
            position: relative;
        }

        .user-clients-dropdown {
            position: relative;
            display: flex;
            align-items: center;
        }

        .view-clients-btn {
            background: #edf2f7;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 4px 8px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
            color: #4a5568;
            font-weight: 500;
        }

        .view-clients-btn:hover {
            background: #e2e8f0;
            border-color: #cbd5e0;
        }

        .view-clients-btn.active {
            background: #4299e1;
            color: white;
            border-color: #3182ce;
        }

        .clients-dropdown {
            position: absolute;
            top: calc(100% + 5px);
            right: 0;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            padding: 8px;
            z-index: 1000;
            min-width: 250px;
            display: none;
        }

        .clients-dropdown.show {
            display: block;
        }

        .clients-dropdown-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .loading-clients {
            color: #718096;
            text-align: center;
            padding: 15px;
            font-style: italic;
            font-size: 12px;
        }

        .client-item {
            padding: 8px 12px;
            margin-bottom: 4px;
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            transition: all 0.2s;
            cursor: pointer;
        }

        .client-item:hover {
            background: #edf2f7;
            border-color: #cbd5e0;
        }

        .client-item:last-child {
            margin-bottom: 0;
        }

        .client-item-name {
            font-weight: 600;
            color: #2d3748;
            font-size: 13px;
            margin-bottom: 2px;
        }

        .client-item-company {
            color: #718096;
            font-size: 11px;
            margin-bottom: 2px;
        }

        .client-item-region {
            display: inline-block;
            background: #e2e8f0;
            color: #4a5568;
            padding: 1px 4px;
            border-radius: 4px;
            font-size: 9px;
            font-weight: bold;
        }

        .no-clients {
            text-align: center;
            color: #718096;
            padding: 15px;
            font-style: italic;
            font-size: 12px;
        }

        /* Custom scrollbar for dropdown */
        .clients-dropdown-list::-webkit-scrollbar {
            width: 6px;
        }

        .clients-dropdown-list::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 3px;
        }

        .clients-dropdown-list::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 3px;
        }

        .clients-dropdown-list::-webkit-scrollbar-thumb:hover {
            background: #a0aec0;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="sidebar">
            <h2>üè¢ Organization</h2>
            <div id="orgStructure" class="loading-text">Loading organization...</div>
        </div>

        <div class="container">
            <div class="header">
                <h1>ü§ñ RAG Sales Chatbot</h1>
                <p>ACME Sales Assistant with fine-grained authorization</p>
            </div>

            <div class="user-selection" id="userSelection">
                <h3>üë§ Select User</h3>
                <select class="user-dropdown" id="userDropdown">
                    <option value="">Choose a user...</option>
                </select>
                
                <div class="user-info" id="userInfo">
                    <div class="user-name" id="selectedUserName"></div>
                    <div class="user-details">
                        <div class="user-role">
                            <span>Role:</span>
                            <span class="role-badge" id="selectedUserRole"></span>
                        </div>
                        <div class="user-region">
                            <span>Region:</span>
                            <span class="region-badge" id="selectedUserRegion"></span>
                        </div>
                        <div class="user-clients-dropdown">
                            <button class="view-clients-btn" id="viewClientsBtn" onclick="toggleClientsDropdown()">
                                <span>üë•</span>
                                <span id="clientCount">0</span>
                                <span>‚ñº</span>
                            </button>
                            <div class="clients-dropdown" id="clientsDropdown">
                                <div class="clients-dropdown-list" id="clientsList">
                                    <div class="loading-clients">Loading clients...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="chat-container">
                <div class="chat-messages" id="chatMessages">
                    <div class="message assistant">
                        Welcome to ACME Sales Assistant! Please select a user above to start chatting. I can help you with information about client notes, pricing discussions, concerns, and more.
                    </div>
                    
                    <div class="message assistant">
                        üîê <strong>Authorization Features:</strong><br>
                        ‚Ä¢ Salespeople can only access their assigned clients<br>
                        ‚Ä¢ Sales managers can access all clients in their region<br>
                        ‚Ä¢ Data is filtered based on your permissions
                    </div>
                    
                    <div class="message assistant">
                        üè¢ <strong>Your Organization:</strong><br>
                        Check the sidebar to see the complete organizational structure with regions, managers, and client assignments.
                    </div>
                    
                    <div class="message assistant">
                        üìä <strong>RAG Technology:</strong><br>
                        This system uses Retrieval-Augmented Generation (RAG) with:<br>
                        ‚Ä¢ Pinecone vector database for similarity search<br>
                        ‚Ä¢ OpenAI embeddings for semantic understanding<br>
                        ‚Ä¢ Oso Cloud for fine-grained authorization
                    </div>
                    
                    <div class="message assistant">
                        üîç <strong>How it works:</strong><br>
                        1. Your questions are converted to vector embeddings<br>
                        2. Similar client notes are retrieved based on your permissions<br>
                        3. AI generates responses using only your authorized data<br>
                        4. Context count shows how many notes were used
                    </div>
                    
                    <div class="suggestions">
                        <h4>üí° Try asking questions like:</h4>
                        <div class="suggestion-buttons">
                            <button class="suggestion-btn" onclick="suggestQuestion('What are the main client concerns?')">Client concerns</button>
                            <button class="suggestion-btn" onclick="suggestQuestion('Show me information about pricing discussions')">Pricing discussions</button>
                            <button class="suggestion-btn" onclick="suggestQuestion('What feedback have we received about our product?')">Product feedback</button>
                            <button class="suggestion-btn" onclick="suggestQuestion('Are there any integration issues mentioned?')">Integration issues</button>
                        </div>
                    </div>
                </div>

                <div class="input-container">
                    <div class="input-group">
                        <input 
                            type="text" 
                            id="messageInput" 
                            placeholder="Ask me anything about your clients..."
                            disabled
                        >
                        <button id="sendButton" disabled>
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M2 21l21-9L2 3v7l15 2-15 2v7z"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let selectedUser = null;
        let isLoading = false;
        let orgData = null;

        // Updated users data with new role names
        const users = [
            { email: 'ceo@company.com', name: 'Shawn Wilson', role: 'ceo', region: 'Organization' },
            { email: 'alice@company.com', name: 'Alice Johnson', role: 'salesperson', region: 'East' },
            { email: 'bob@company.com', name: 'Bob Smith', role: 'salesperson', region: 'East' },
            { email: 'carol@company.com', name: 'Carol Williams', role: 'salesmanager', region: 'East' },
            { email: 'david@company.com', name: 'David Brown', role: 'salesperson', region: 'West' },
            { email: 'eve@company.com', name: 'Eve Davis', role: 'salesperson', region: 'West' },
            { email: 'frank@company.com', name: 'Frank Miller', role: 'salesmanager', region: 'West' }
        ];

        // Load organization structure
        async function loadOrganization() {
            try {
                const response = await fetch('/api/clients');
                if (response.ok) {
                    orgData = await response.json();
                    renderOrganization();
                } else {
                    document.getElementById('orgStructure').innerHTML = '<div class="loading-text">Failed to load organization data</div>';
                }
            } catch (error) {
                console.error('Error loading organization:', error);
                document.getElementById('orgStructure').innerHTML = '<div class="loading-text">Error loading organization</div>';
            }
        }

        // Render organization structure
        function renderOrganization() {
            if (!orgData || !orgData.regions) return;

            const container = document.getElementById('orgStructure');
            container.innerHTML = '';

            // Add CEO at the top if available
            if (orgData.ceo) {
                const ceoDiv = document.createElement('div');
                ceoDiv.className = 'region';
                ceoDiv.style.marginBottom = '20px';
                ceoDiv.style.border = '2px solid #9f7aea';

                const ceoHeader = document.createElement('div');
                ceoHeader.className = 'region-header';
                ceoHeader.style.background = '#9f7aea';
                ceoHeader.innerHTML = `
                    <span>üëë</span>
                    <span>CEO - ${orgData.ceo.name}</span>
                `;

                const ceoInfo = document.createElement('div');
                ceoInfo.className = 'manager';
                ceoInfo.style.background = '#f7fafc';
                ceoInfo.innerHTML = `
                    <span>üìß</span>
                    <span>${orgData.ceo.email}</span>
                    <span class="manager-badge" style="background: #9f7aea;">CEO</span>
                `;

                ceoDiv.appendChild(ceoHeader);
                ceoDiv.appendChild(ceoInfo);
                container.appendChild(ceoDiv);
            }

            orgData.regions.forEach(region => {
                const regionDiv = document.createElement('div');
                regionDiv.className = 'region';

                const regionHeader = document.createElement('div');
                regionHeader.className = `region-header ${region.name.toLowerCase()}`;
                regionHeader.innerHTML = `
                    <span>üåç</span>
                    <span>${region.name} Region</span>
                `;

                const managerDiv = document.createElement('div');
                managerDiv.className = 'manager';
                managerDiv.innerHTML = `
                    <span>üëî</span>
                    <span>${region.manager ? region.manager.name : 'No Manager'}</span>
                    <span class="manager-badge">Manager</span>
                `;

                const clientsDiv = document.createElement('div');
                clientsDiv.className = 'clients';

                region.clients.forEach(client => {
                    const clientDiv = document.createElement('div');
                    clientDiv.className = 'client';
                    clientDiv.innerHTML = `
                        <div class="client-info">
                            <div class="client-name">${client.name}</div>
                            <div class="client-company">${client.company}</div>
                        </div>
                        <div class="salesperson">${client.assigned_salesperson ? client.assigned_salesperson.name.split(' ')[0] : 'Unassigned'}</div>
                    `;
                    clientsDiv.appendChild(clientDiv);
                });

                regionDiv.appendChild(regionHeader);
                regionDiv.appendChild(managerDiv);
                regionDiv.appendChild(clientsDiv);
                container.appendChild(regionDiv);
            });
        }

        // Load users into the dropdown
        function loadUsers() {
            const userDropdown = document.getElementById('userDropdown');
            
            users.forEach(user => {
                const option = document.createElement('option');
                option.value = user.email;
                let roleText = 'Salesperson';
                if (user.role === 'salesmanager') roleText = 'Sales Manager';
                if (user.role === 'ceo') roleText = 'CEO';
                
                option.textContent = `${user.name} - ${roleText} (${user.region}${user.role !== 'ceo' ? ' Region' : ''})`;
                userDropdown.appendChild(option);
            });
        }

        // Toggle clients dropdown
        function toggleClientsDropdown() {
            const dropdown = document.getElementById('clientsDropdown');
            const btn = document.getElementById('viewClientsBtn');
            
            dropdown.classList.toggle('show');
            btn.classList.toggle('active');
            
            // Update arrow direction
            const arrow = btn.querySelector('span:last-child');
            arrow.textContent = dropdown.classList.contains('show') ? '‚ñ≤' : '‚ñº';
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('clientsDropdown');
            const btn = document.getElementById('viewClientsBtn');
            
            if (dropdown && btn && !btn.contains(event.target) && !dropdown.contains(event.target)) {
                dropdown.classList.remove('show');
                btn.classList.remove('active');
                const arrow = btn.querySelector('span:last-child');
                if (arrow) arrow.textContent = '‚ñº';
            }
        });

        // Load clients for selected user
        async function loadUserClients(userEmail) {
            const clientsList = document.getElementById('clientsList');
            const clientCount = document.getElementById('clientCount');
            
            // Show loading state
            clientsList.innerHTML = '<div class="loading-clients">Loading clients...</div>';
            clientCount.textContent = '0';
            
            try {
                const response = await fetch('/api/clients-by-user', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ userEmail: userEmail })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    renderUserClients(data.clients);
                    clientCount.textContent = data.totalClients.toString();
                } else {
                    throw new Error('Failed to load clients');
                }
            } catch (error) {
                console.error('Error loading user clients:', error);
                clientsList.innerHTML = '<div class="no-clients">Failed to load clients</div>';
                clientCount.textContent = '0';
            }
        }
        
        // Render user clients
        function renderUserClients(clients) {
            const clientsList = document.getElementById('clientsList');
            
            if (!clients || clients.length === 0) {
                clientsList.innerHTML = '<div class="no-clients">No clients assigned</div>';
                return;
            }
            
            clientsList.innerHTML = '';
            
            clients.forEach(client => {
                const clientDiv = document.createElement('div');
                clientDiv.className = 'client-item';
                clientDiv.innerHTML = `
                    <div class="client-item-name">${client.name}</div>
                    <div class="client-item-company">${client.company}</div>
                    <div class="client-item-region">${client.region}</div>
                `;
                clientsList.appendChild(clientDiv);
            });
        }

        // Handle user selection
        function handleUserSelection() {
            const userDropdown = document.getElementById('userDropdown');
            const selectedEmail = userDropdown.value;
            
            if (!selectedEmail) {
                document.getElementById('userInfo').classList.remove('active');
                document.getElementById('messageInput').disabled = true;
                document.getElementById('sendButton').disabled = true;
                selectedUser = null;
                return;
            }

            selectedUser = users.find(u => u.email === selectedEmail);
            
            if (selectedUser) {
                // Update user info display
                document.getElementById('selectedUserName').textContent = selectedUser.name;
                
                let roleText = 'Salesperson';
                let roleClass = '';
                if (selectedUser.role === 'salesmanager') {
                    roleText = 'Sales Manager';
                    roleClass = 'manager';
                } else if (selectedUser.role === 'ceo') {
                    roleText = 'CEO';
                    roleClass = 'manager';
                }
                
                document.getElementById('selectedUserRole').textContent = roleText;
                document.getElementById('selectedUserRole').className = `role-badge ${roleClass}`;
                document.getElementById('selectedUserRegion').textContent = selectedUser.region;
                document.getElementById('selectedUserRegion').className = `region-badge ${selectedUser.region.toLowerCase()}`;
                
                // Load user clients
                loadUserClients(selectedUser.email);
                
                document.getElementById('userInfo').classList.add('active');
                
                // Enable input
                document.getElementById('messageInput').disabled = false;
                document.getElementById('sendButton').disabled = false;
                
                // Add welcome message
                let permissions = 'your assigned clients';
                if (selectedUser.role === 'salesmanager') {
                    permissions = `all clients in the ${selectedUser.region} region`;
                } else if (selectedUser.role === 'ceo') {
                    permissions = 'all client information across the organization';
                }
                    
                addMessage('assistant', `Hello, ${selectedUser.name}! I'm your ACME sales assistant. You can see ${permissions}. How can I help you today?`);
            }
        }

        // Add message to chat
        function addMessage(type, content) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = content;
            chatMessages.appendChild(messageDiv);
            
            // Force scroll to bottom with slight delay to ensure content is rendered
            setTimeout(() => {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }, 100);
        }

        // Add loading indicator
        function addLoadingMessage() {
            const chatMessages = document.getElementById('chatMessages');
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'message assistant loading';
            loadingDiv.innerHTML = '<div class="spinner"></div>Thinking...';
            loadingDiv.id = 'loadingMessage';
            chatMessages.appendChild(loadingDiv);
            
            // Force scroll to bottom
            setTimeout(() => {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }, 100);
        }

        // Remove loading indicator
        function removeLoadingMessage() {
            const loadingMessage = document.getElementById('loadingMessage');
            if (loadingMessage) {
                loadingMessage.remove();
            }
        }

        // Send message
        async function sendMessage() {
            if (!selectedUser || isLoading) return;
            
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            if (!message) return;
            
            // Add user message
            addMessage('user', message);
            input.value = '';
            
            // Set loading state
            isLoading = true;
            document.getElementById('sendButton').disabled = true;
            addLoadingMessage();
            
            try {
                // Call API
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user: selectedUser.email,
                        message: message
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    removeLoadingMessage();
                    
                    // Add main response
                    addMessage('assistant', data.response);
                    
                    // Add context info if available
                    if (data.contextCount !== undefined) {
                        const contextInfo = data.contextCount > 0 
                            ? `üìä Found ${data.contextCount} relevant client note${data.contextCount === 1 ? '' : 's'} to answer your question.`
                            : `üîí No accessible information found. This might be due to authorization restrictions.`;
                        
                        addContextInfo(contextInfo, data.contextCount);
                    }
                } else {
                    throw new Error('API request failed');
                }
                
            } catch (error) {
                removeLoadingMessage();
                console.error('Chat error:', error);
                
                // Demo mode - show authorization-aware mock responses
                const mockResponse = generateMockResponse(selectedUser, message);
                addMessage('assistant', mockResponse);
                addContextInfo('üîÑ Running in demo mode - using simulated responses.', 0);
            } finally {
                isLoading = false;
                document.getElementById('sendButton').disabled = false;
            }
        }

        // Add context information message
        function addContextInfo(text, contextCount) {
            const chatMessages = document.getElementById('chatMessages');
            const contextDiv = document.createElement('div');
            contextDiv.className = 'message context-info';
            contextDiv.style.cssText = `
                background: ${contextCount > 0 ? '#e6fffa' : '#fef5e7'};
                border: 1px solid ${contextCount > 0 ? '#38b2ac' : '#ed8936'};
                color: ${contextCount > 0 ? '#234e52' : '#744210'};
                font-size: 12px;
                margin: 5px 0;
                padding: 8px 12px;
                border-radius: 8px;
                max-width: 60%;
                font-style: italic;
            `;
            contextDiv.textContent = text;
            chatMessages.appendChild(contextDiv);
            
            // Force scroll to bottom
            setTimeout(() => {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }, 100);
        }

        // Generate mock responses based on user permissions
        function generateMockResponse(user, message) {
            const isManager = user.role === 'salesmanager';
            const region = user.region;
            
            if (message.toLowerCase().includes('concern') || message.toLowerCase().includes('problem')) {
                if (isManager) {
                    return `Based on ${region} region client notes, the main concerns are: pricing competitiveness (20% higher than competitors mentioned by several clients), integration complexity with legacy systems, and performance requirements for high-traffic scenarios. As a ${region} region manager, I can see patterns across all ${region} clients that suggest these are regional priorities.`;
                } else {
                    return `Looking at your assigned clients, the main concerns include: pricing discussions where clients mentioned competitor alternatives, and some technical integration questions about API compatibility. These insights are from your specific client relationships.`;
                }
            }
            
            if (message.toLowerCase().includes('pricing')) {
                if (isManager) {
                    return `Pricing discussions across ${region} region show: 3 clients requested volume discounts, 2 mentioned budget constraints but see value proposition, and 1 needs flexible payment terms. Regional trend: ${region === 'East' ? 'enterprise clients prefer annual contracts' : 'startups prefer monthly billing'}.`;
                } else {
                    return `From your client notes: pricing discussions show interest in ROI projections, volume discounts for multi-year contracts, and some budget approval processes in progress. Specific amounts mentioned: $50K budget approved, looking for cost justification documents.`;
                }
            }
            
            if (message.toLowerCase().includes('feedback') || message.toLowerCase().includes('satisfaction')) {
                return `${isManager ? `Across ${region} region` : 'From your clients'}: 95% user adoption rates reported, 30% improvement in operational efficiency, positive feedback on dashboard functionality and reporting capabilities. ${isManager ? 'Regional pattern shows higher satisfaction in enterprise accounts.' : 'Your clients particularly appreciate the interface design.'}`;
            }
            
            return `I can see ${isManager ? `all ${region} region client` : 'your assigned client'} information. The authorization system is working - you have ${isManager ? 'manager-level' : 'salesperson-level'} access. Ask me about client concerns, pricing discussions, or product feedback for more specific insights.`;
        }

        // Suggest a question
        function suggestQuestion(question) {
            if (selectedUser) {
                document.getElementById('messageInput').value = question;
            }
        }

        // Event listeners
        document.getElementById('userDropdown').addEventListener('change', handleUserSelection);
        document.getElementById('sendButton').addEventListener('click', sendMessage);
        document.getElementById('messageInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Initialize
        loadUsers();
        loadOrganization();
        
        // Ensure chat scrolls to bottom on page load
        window.addEventListener('load', () => {
            setTimeout(() => {
                const chatMessages = document.getElementById('chatMessages');
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }, 500);
        });
    </script>
</body>
</html> 